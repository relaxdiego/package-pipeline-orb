description: >
  Builds and test an orb.

# The circleci-cli orb is declared in src/@orb.yml
executor: circleci-cli/default

parameters:
  package-repo:
    description: >
      The name or URL of the package repo. The format of this parameter will
      depend on the value of package-repo-provider.
    type: string

  package-repo-provider:
    description: The backend provider of the package repo.
    type: string
    default: cricleci-orb

  package-type:
    description: The type of package being built.
    type: string
    default: cricleci-orb

  versioning-provider:
    description: Which versioning scheme to use when naming the package.
    type: enum
    enum:
      - semver2

steps:
  - run:
      name: Print debug info
      command: |
        echo "
        package-repo         : << parameters.package-repo >>
        package-repo-provider: << parameters.package-repo-provider >>
        package-type         : << parameters.package-type >>
        versioning-provider  : << parameters.versioning-provider >>
        "

  - checkout

  - run:
      name: Render BUILD-INFO
      environment:
        PIPELINE_VERSIONING_PROVIDER: << parameters.versioning-provider >>
      command: <<include(scripts/render-build-info.sh)>>

  # TODO: Should we add a step here that installs necessary binaries
  #       depending on the value of packae-repo-provider and package-type?

  - run:
      name: Build and test
      environment:
        PIPELINE_PACKAGE_TYPE: << parameters.package-type >>
      command: <<include(scripts/build-and-test.sh)>>

  - jq/install

  # # This should be in a separate job
  # - run:
  #     name: Publish the build
  #     environment:
  #       PIPELINE_PACKAGE_REPO: << parameters.package-repo >>
  #       PIPELINE_PACKAGE_REPO_PROVIDER: << parameters.package-repo-provider >>
  #     command: <<include(scripts/publish.sh)>>
